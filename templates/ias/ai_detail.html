{% extends 'base.html' %}
{% load ias_filter %}
{% block content %}
<div class="container my-3">
    <!-- message 표시 -->
    {% if messages %}
    <div class="alert alert-danger my-3" role="alert">
        {% for message in messages %}
        <strong>{{ message.tags }}</strong>
        <ul>
            <li>{{ message.message }}</li>
        </ul>
        {% endfor %}
    </div>
    {% endif %}
    <!-- Article -->
    <h2 class="border-bottom py-2" id="subjectDisplay">{{ ai.pk }}. {{ ai.engSubject }}</h2>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text">
                {{ai.engContent}}
<!--                {% for word in ai.engContent %}-->
<!--                    <pre-wrap href="#" class="word-link">{{ word }}</pre-wrap>-->
<!--                {% endfor %}-->
            </div>

            <div class="d-flex justify-content-end">
            </div>
            <div class="my-3">
            </div>
        </div>
    </div>
    <div class="text-start mb-3">
        <!-- Toggle button for translation -->
        <input type="checkbox" id="toggleTranslationBtn" class="toggle-input visually-hidden">
        <label for="toggleTranslationBtn" class="toggle-label btn btn-outline-primary">Toggle Translation</label>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" onclick="showDiscussion()">Discussion</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="showInput(); document.querySelector('.nav-link.active').classList.remove('active');">Assignment</a>
        </li>
    </ul>
    </div>

    <!-- Discussion and Input Section -->
    <div class="discussion-prompt" style="display: none;">
        <!-- Display existing comments -->
        <div class="existing-comments mt-3">
            <h4 class="border-bottom my-3 py-2">{{ ai.opinion_set.count }} Opinions</h4>
            <ul>
                {% if ai.opinion_set.all %}
                    {% for opinion in ai.opinion_set.all reversed%}
                        <a id="opinion_{{ opinion.id }}"></a>
                        <div class="card my-1">
                            <div class="card-body">
                                <div class="card-text">
                                    <pre class="pre-wrap">{{ opinion.opinion | mark }}</pre>
                                </div>
                            </div>
                            <div class="d-flex justify-content">
                                <div class="badge bg-light text-dark p-1 text-start">
                                    <div class="mb-1">{{ opinion.author }}</div>
                                    <div>{{ opinion.create_date }}</div>
                                </div>
                                {% if opinion.modify_date %}
                                <div class="badge bg-light text-dark p-1 text-start mx-3">
                                    <div class="mb-1">modified at</div>
                                    <div>{{ opinion.modify_date }}</div>
                                </div>
                                {% endif %}
                                <div class="my-1">
                                    <a href="javascript:void(0)" data-uri="{% url 'discussion:opinion_vote' opinion.id  %}"
                                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                                        <span class="badge rounded-pill bg-success">{{opinion.voter.count}}</span>
                                    </a>
                                    {% if request.user == opinion.author %}
                                    <a href="{% url 'discussion:opinion_modify' opinion.id  %}"
                                       class="btn btn-sm btn-outline-secondary">Edit</a>
                                    <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-secondary "
                                       data-uri="{% url 'discussion:opinion_delete' opinion.id  %}">Delete</a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No comments yet.</p>
                {% endif %}
            </ul>
        </div>
        <!-- Discussion prompt-->
        <form action="{% url 'discussion:opinion_create' ai.id %}" method="post" class="my-3">
            {% csrf_token %}
            <!-- Add your discussion form fields here -->
            <div class="mb-3">
<!--                <label for="comment" class="form-label">Discussion</label>-->
                <textarea name="comment" id="comment" class="form-control" rows="5"></textarea>
            </div>
            <input type="submit" value="Submit Discussion" class="btn btn-primary">
        </form>

    </div>

<!-- Audio recording and transcription -->
<div class="container my-3">
    <button id="recordBtn" class="btn btn-primary">Record</button>
    <!-- Button to stop recording (initially hidden) -->
    <button id="stopBtn" class="btn btn-danger" style="display: none;">Stop</button>

    <!-- Div to display transcription result -->
    <div id="transcriptionResult" class="mt-3"></div>
</div>


    <!-- Input prompt -->
    <div class="input-prompt" style="display: none;">
        <form action="{% url 'ias:input_create' ai.id %}" method="post" class="my-3">
            {% csrf_token %}
            {% include "form_errors.html" %}

            <div class="mb-3">
                <label for="content" class="form-label">Input</label>
                {% if ai.pk < recentWeek %}
                <textarea {% if not user.is_authenticated %}disabled{% endif %}
                          name="content" id="content" class="form-control" rows="5" disabled></textarea>
                {% else %}
                <textarea {% if not user.is_authenticated %}disabled{% endif %}
                          name="content" id="content2" class="form-control" rows="5"></textarea>
                {% endif %}

            </div>


            <input type="submit" value="Submit Assignment" class="btn btn-primary">
        </form>
        <!-- Responses -->
        <h4 class="border-bottom my-3 py-2">{{ai.input_set.count}} Responses</h4>
        {% for input in ai.input_set.all reversed %}
        <a id="input_{{ input.id }}"></a>
        <div class="card my-3 {% if input.isTheSame %}border-3 border-success{% else %}border-2 border-danger{% endif %}">
            <div class="card-body">
                {% if input.isTheSame %}
                <div class="card-text">
                    {% if input.errCheckedStr %}
                    <pre class="pre-wrap">{{ input.errCheckedStr|mark }}</pre>
                    {% elif input.content %}
                    <pre class="pre-wrap">{{ input.content|mark }}</pre>
                    {% endif %}</div>
                <div class="d-flex justify-content-end">
                    {% if input.modify_date %}
                    <div class="badge bg-light text-dark p-2 text-start mx-3">
                        <div class="mb-2">modified at</div>
                        <div>{{ input.modify_date }}</div>
                    </div>
                    {% endif %}
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ input.author.username }}</div>
                        <div>{{ input.create_date }}</div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0)" data-uri="{% url 'ias:input_vote' input.id  %}"
                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                        <span class="badge rounded-pill bg-success">{{input.voter.count}}</span>
                    </a>
                    {% if request.user == input.author %}
                    <a href="{% url 'ias:input_modify' input.id  %}"
                       class="btn btn-sm btn-outline-secondary">Edit</a>
                    <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-secondary "
                       data-uri="{% url 'ias:input_delete' input.id  %}">Delete</a>
                    {% endif %}
                </div>
                {% else %}
                <!-- Handle the case when input.isTheSame is false -->
                <div class="card-text">
                    {% if input.errCheckedStr %}
                    <pre class="pre-wrap">{{ input.errCheckedStr|mark }}</pre>
                    {% elif input.content %}
                    <pre class="pre-wrap">{{ input.content|mark }}</pre>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-end">
                    {% if input.modify_date %}
                    <div class="badge bg-light text-dark p-2 text-start mx-3">
                        <div class="mb-2">modified at</div>
                        <div>{{ input.modify_date }}</div>
                    </div>
                    {% endif %}
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ input.author.username }}</div>
                        <div>{{ input.create_date }}</div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0)" data-uri="{% url 'ias:input_vote' input.id  %}"
                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                        <span class="badge rounded-pill bg-success">{{input.voter.count}}</span>
                    </a>
                    {% if request.user == input.author %}
                    <a href="{% url 'ias:input_modify' input.id  %}"
                       class="btn btn-sm btn-outline-secondary">Edit</a>
                    <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-secondary "
                       data-uri="{% url 'ias:input_delete' input.id  %}">Delete</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</div>

{% endblock content %}
{% block script %}
<script>
    document.getElementById('recordBtn').addEventListener('click', function() {
        // Show the stop button and hide the record button
        document.getElementById('recordBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = '';

        // Send a POST request to start recording
        fetch("{% url 'voice:transcribe_audio' ai.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to start recording');
            }
        })
        .catch(error => {
            console.error('Error starting recording:', error);
            alert('An error occurred while starting recording.');
        });
    });

    document.getElementById('stopBtn').addEventListener('click', function() {
        // Send a POST request to stop recording
        fetch("{% url 'voice:interrupt' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to stop recording');
            }
        })
        .catch(error => {
            console.error('Error stopping recording:', error);
            alert('An error occurred while stopping recording.');
        })
        .finally(() => {
            // Hide the stop button and show the record button
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('recordBtn').style.display = '';
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle the translation toggle
        const toggleTranslationBtn = document.getElementById('toggleTranslationBtn');
        toggleTranslationBtn.addEventListener('change', function() {
            if (this.checked) {
                showTranslation();
            } else {
                hideTranslation();
            }
        });
    });

    function showTranslation() {
        document.querySelectorAll('.korean').forEach(function(el) {
            el.style.display = 'inline';
        });
    }

    function hideTranslation() {
        document.querySelectorAll('.korean').forEach(function(el) {
            el.style.display = 'none';
        });
    }

    function showDiscussion() {
        document.querySelector('.discussion-prompt').style.display = 'block';
        document.querySelector('.input-prompt').style.display = 'none';
    }

    function showInput() {
        document.querySelector('.discussion-prompt').style.display = 'none';
        document.querySelector('.input-prompt').style.display = 'block';
    }

    function handleWordClick(word) {
        fetchTranslation(word);
    }

    function fetchTranslation(word) {
        const apiUrl = `{% url 'voice:transcribe_audio' ai.pk %}?word=${encodeURIComponent(word)}`;
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                alert(data.translation);
            })
            .catch(error => {
                console.error('Error fetching translation:', error);
            });
    }

    // Audio upload and transcription
    function uploadAndTranscribeAudio() {
        const audioFile = document.getElementById('audioUpload').files[0];
        const formData = new FormData();
        formData.append('audio', audioFile);

        fetch('{% url "voice:transcribe_audio" ai.pk %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            const transcriptionResult = document.getElementById('transcriptionResult');
            if (data.success) {
                transcriptionResult.innerHTML = `<pre>${data.transcription}</pre>`;
            } else {
                transcriptionResult.innerHTML = `<p>Error: ${data.error}</p>`;
            }
        })
        .catch(error => {
            console.error('Error uploading or transcribing audio:', error);
        });
    }

    // Attach event listeners to delete buttons
    document.querySelectorAll('.delete').forEach(button => {
        button.addEventListener('click', function() {
            const uri = this.getAttribute('data-uri');
            fetch(uri, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete');
                }
            });
        });
    });

    // Attach event listeners to recommend buttons
    document.querySelectorAll('.recommend').forEach(button => {
        button.addEventListener('click', function() {
            const uri = this.getAttribute('data-uri');
            fetch(uri, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to recommend');
                }
            });
        });
    });
</script>
{% endblock script %}
