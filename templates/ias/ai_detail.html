{% extends 'base.html' %}
{% load ias_filter %}
{% block content %}
<div class="container my-3">
    <!-- message 표시 -->
    {% if messages %}
    <div class="alert alert-danger my-3" role="alert">
        {% for message in messages %}
        <strong>{{ message.tags }}</strong>
        <ul>
            <li>{{ message.message }}</li>
        </ul>
        {% endfor %}
    </div>
    {% endif %}
    <!-- Article -->
    <h2 class="border-bottom py-2" id="subjectDisplay">{{ ai.engSubject }}</h2>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text">
                {% for word in ai.engContent %}
                    <a href="#" class="word-link" onclick="handleWordClick('{{ word|escapejs }}'); return false;">{{ word }}</a>
                {% endfor %}
            </div>

            <div class="d-flex justify-content-end">
            </div>
            <div class="my-3">
            </div>
        </div>
    </div>
    <div class="text-start mb-3">
        <!-- Toggle button for translation -->
        <input type="checkbox" id="toggleTranslationBtn" class="toggle-input visually-hidden">
        <label for="toggleTranslationBtn" class="toggle-label btn btn-outline-primary">Toggle Translation</label>

    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" href="#" onclick="showDiscussion()">Discussion</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="showInput(); document.querySelector('.nav-link.active').classList.remove('active');">Assignment</a>
        </li>
    </ul>
    </div>

    <!-- Discussion and Input Section -->
    <div class="discussion-prompt" style="display: none;">
        <!-- Display existing comments -->
        {% if ai.opinion_set.all %}
        <div class="existing-comments mt-3">
            <h4>Opinions</h4>
            <ul>
                {% for comment in ai.opinion_set.all %}
                <li>{{ comment.opinion }} - {{ comment.author }}</li>
                <!-- Add any other fields you want to display -->
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <p>No comments yet.</p>
        {% endif %}
        <!-- Discussion prompt-->
        <form action="{% url 'discussion:opinion_create' ai.id %}" method="post" class="my-3">
            {% csrf_token %}
            <!-- Add your discussion form fields here -->
            <div class="mb-3">
<!--                <label for="comment" class="form-label">Discussion</label>-->
                <textarea name="comment" id="comment" class="form-control" rows="5"></textarea>
            </div>
            <input type="submit" value="Submit Discussion" class="btn btn-primary">
        </form>

    </div>

    <!-- Input prompt -->
    <div class="input-prompt" style="display: none;">
        <form action="{% url 'ias:input_create' ai.id %}" method="post" class="my-3">
            {% csrf_token %}
            {% include "form_errors.html" %}
            <div class="mb-3">
                <label for="content" class="form-label">Input</label>
                <textarea {% if not user.is_authenticated %}disabled{% endif %}
                          name="content" id="content" class="form-control" rows="5"></textarea>
            </div>
            <input type="submit" value="Register Input" class="btn btn-primary">
        </form>
        <!-- Responses -->
        <h5 class="border-bottom my-3 py-2">{{ai.input_set.count}} Responses</h5>
        {% for input in ai.input_set.all reversed %}
        <a id="input_{{ input.id }}"></a>
        <div class="card my-3 {% if input.isTheSame %}border-3 border-success{% else %}border-2 border-danger{% endif %}">
            <div class="card-body">
                {% if input.isTheSame %}
                <div class="card-text">
                    {% if input.errCheckedStr %}
                    <pre class="pre-wrap">{{ input.errCheckedStr|mark }}</pre>
                    {% elif input.content %}
                    <pre class="pre-wrap">{{ input.content|mark }}</pre>
                    {% endif %}</div>
                <div class="d-flex justify-content-end">
                    {% if input.modify_date %}
                    <div class="badge bg-light text-dark p-2 text-start mx-3">
                        <div class="mb-2">modified at</div>
                        <div>{{ input.modify_date }}</div>
                    </div>
                    {% endif %}
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ input.author.username }}</div>
                        <div>{{ input.create_date }}</div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0)" data-uri="{% url 'ias:input_vote' input.id  %}"
                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                        <span class="badge rounded-pill bg-success">{{input.voter.count}}</span>
                    </a>
                    {% if request.user == input.author %}
                    <a href="{% url 'ias:input_modify' input.id  %}"
                       class="btn btn-sm btn-outline-secondary">Edit</a>
                    <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-secondary "
                       data-uri="{% url 'ias:input_delete' input.id  %}">Delete</a>
                    {% endif %}
                </div>
                {% else %}
                <!-- Handle the case when input.isTheSame is false -->
                <div class="card-text">
                    {% if input.errCheckedStr %}
                    <pre class="pre-wrap">{{ input.errCheckedStr|mark }}</pre>
                    {% elif input.content %}
                    <pre class="pre-wrap">{{ input.content|mark }}</pre>
                    {% endif %}</div>
                <div class="d-flex justify-content-end">
                    {% if input.modify_date %}
                    <div class="badge bg-light text-dark p-2 text-start mx-3">
                        <div class="mb-2">modified at</div>
                        <div>{{ input.modify_date }}</div>
                    </div>
                    {% endif %}
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ input.author.username }}</div>
                        <div>{{ input.create_date }}</div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0)" data-uri="{% url 'ias:input_vote' input.id  %}"
                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                        <span class="badge rounded-pill bg-success">{{input.voter.count}}</span>
                    </a>
                    {% if request.user == input.author %}
                    <a href="{% url 'ias:input_modify' input.id  %}"
                       class="btn btn-sm btn-outline-secondary">Edit</a>
                    <a href="javascript:void(0)" class="delete btn btn-sm btn-outline-secondary "
                       data-uri="{% url 'ias:input_delete' input.id  %}">Delete</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block script %}

<script type="text/javascript">

    // Function to show discussion section when the page loads
    window.addEventListener('DOMContentLoaded', function() {
        showDiscussion();
    });

    function showDiscussion() {
        // Logic to show discussion content
        var discussionPrompt = document.querySelector('.discussion-prompt');
        var inputPrompt = document.querySelector('.input-prompt');

        discussionPrompt.style.display = 'block';
        inputPrompt.style.display = 'none'; // Hide input prompt

        console.log("Discussion content shown");
    }

    function showInput() {
        // Logic to show input prompt
        var discussionPrompt = document.querySelector('.discussion-prompt');
        var inputPrompt = document.querySelector('.input-prompt');

        inputPrompt.style.display = 'block';
        discussionPrompt.style.display = 'none'; // Hide discussion prompt

        console.log("Input prompt shown");
    }

</script>

<script type='text/javascript'>

const delete_elements = document.getElementsByClassName("delete");
Array.from(delete_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("Sure to delete?")) {
            location.href = this.dataset.uri;
        };
    });
});
const recommend_elements = document.getElementsByClassName("recommend");
Array.from(recommend_elements).forEach(function(element) {
    element.addEventListener('click', function() {
        if(confirm("Sure to recommend?")) {
            location.href = this.dataset.uri;
        };
    });
});
</script>

<script type='text/javascript'>
    // Get references to the toggle button and subject/content display elements
    const toggleButton = document.getElementById('toggleTranslationBtn');
    const subjectDisplay = document.getElementById('subjectDisplay');
    const contentDisplay = document.querySelector('.card-text');
    const toggleLabel = document.querySelector('.toggle-label');
    const responseSection = document.getElementById('responseSection');
    const discussionSection = document.getElementById('discussionSection'); // Added reference for discussion section
    const discussinLabel = document.querySelector('.discussion-toggle-label');
    // Initial values for subject and content
    const engSubject = "{{ ai.engSubject }}";
    const korSubject = "{{ ai.korSubject }}";
    const engContent = "{{ ai.engContent|mark }}";
    const korContent = "{{ ai.korContent|mark }}";

    // Set the initial subject and content display
    subjectDisplay.textContent = engSubject;
    contentDisplay.innerHTML = engContent;

    // Set the initial label text
    toggleLabel.textContent = "Korean";

    // Function to prevent copying
    function preventCopy(event) {
        event.preventDefault();
        alert('Copying is disabled in English Mode.');
    }

    // Initially disable copying
    document.addEventListener('copy', preventCopy);

    // Function to show or hide responses based on toggle state
    function toggleResponses() {
        console.log("Toggle button checked:", toggleButton.checked);
        if (toggleButton.checked) {
            responseSection.style.display = "block";
            console.log("Responses shown");
        } else {
            responseSection.style.display = "none";
            console.log("Responses hidden");
        }
    }

    // Function to show or hide discussion section based on toggle state
    // Add event listener to the toggle button
    toggleButton.addEventListener('change', function() {
        // Update the subject and content display based on the toggle state
        if (toggleButton.checked) {
            subjectDisplay.textContent = korSubject;
            contentDisplay.innerHTML = korContent;
            toggleLabel.textContent = "English";
            // Enable copying when in Korean mode
            document.removeEventListener('copy', preventCopy);
        } else {
            subjectDisplay.textContent = engSubject;
            contentDisplay.innerHTML = engContent;
            toggleLabel.textContent = "Korean";
            // Disable copying when in English mode
            document.addEventListener('copy', preventCopy);
        }
        // Show or hide responses based on toggle state
        toggleResponses();
    });

    // Add event listener to the toggle section button
    toggleSectionBtn.addEventListener('change', function() {
        // Show or hide discussion section based on toggle state
        toggleDiscussion();
    });

    // Call toggleResponses() initially to set the initial state
    toggleResponses();
</script>

<script>
    // Function to handle word click
    function handleWordClick(word) {
        // Make an AJAX request to fetch the Korean translation of the clicked word
        fetchKoreanTranslation(word);
    }

    // Function to fetch Korean translation
    function fetchKoreanTranslation(word) {
        // Make an AJAX request to your backend to fetch the Korean translation
        // Replace the alert with your logic to display the translation
        alert("Korean translation of '" + word + "' will be displayed here.");
    }
</script>


{% endblock %}
