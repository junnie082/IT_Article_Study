{% extends 'base.html' %}
{% load ias_filter %}
{% block content %}
<div class="container my-3">
    <!-- message 표시 -->
    {% if messages %}
    <div class="alert alert-danger my-3" role="alert">
        {% for message in messages %}
        <strong>{{ message.tags }}</strong>
        <ul>
            <li>{{ message.message }}</li>
        </ul>
        {% endfor %}
    </div>
    {% endif %}
    <!-- Article -->
    <h2 class="border-bottom py-2" id="subjectDisplay">{{ ai.pk }}. {{ ai.engSubject }}</h2>
    <div class="card my-3">
        <div class="card-body">
            <div class="card-text">
                {{ai.engContent}}
            </div>
            <div class="d-flex justify-content-end">
            </div>
            <div class="my-3">
            </div>
        </div>
    </div>
    <div class="text-start mb-3">
        <!-- Toggle button for translation -->
        <input type="checkbox" id="toggleTranslationBtn" class="toggle-input visually-hidden">
        <label for="toggleTranslationBtn" class="toggle-label btn btn-outline-primary">Toggle Translation</label>

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showDiscussion()">Discussion</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showInput(); document.querySelector('.nav-link.active').classList.remove('active');">Assignment</a>
            </li>
        </ul>
    </div>

    <!-- Discussion and Input Section -->
    <div class="discussion-prompt" style="display: block;">
        <!-- Display existing comments -->
        <div class="existing-comments mt-3">
            <h4 class="border-bottom my-3 py-2">{{ ai.opinion_set.count }} Opinions</h4>
            <ul>
                {% if ai.opinion_set.all %}
                    {% for opinion in ai.opinion_set.all reversed %}
                        <a id="opinion_{{ opinion.id }}"></a>
                        <div class="card my-1">
                            <div class="card-body">
                                <div class="card-text">
                                    <pre class="pre-wrap">{{ opinion.opinion | mark }}</pre>
                                </div>
                            </div>
                            <div class="d-flex justify-content">
                                <div class="badge bg-light text-dark p-1 text-start">
                                    <div class="mb-1">{{ opinion.author }}</div>
                                    <div>{{ opinion.create_date }}</div>
                                </div>
                                {% if opinion.modify_date %}
                                <div class="badge bg-light text-dark p-1 text-start mx-3">
                                    <div class="mb-1">modified at</div>
                                    <div>{{ opinion.modify_date }}</div>
                                </div>
                                {% endif %}
                                <div class="my-1">
                                    <a href="javascript:void(0)" data-uri="{% url 'discussion:opinion_vote' opinion.id  %}"
                                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                                        <span class="badge rounded-pill bg-success">{{opinion.voter.count}}</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p>No comments yet.</p>
                {% endif %}
            </ul>
        </div>
        <!-- Discussion prompt-->
        <form action="{% url 'discussion:opinion_create' ai.id %}" method="post" class="my-3">
            {% csrf_token %}
            <!-- Add your discussion form fields here -->
            <div class="mb-3">
                <textarea name="comment" id="comment" class="form-control" rows="5"></textarea>
            </div>
            <input type="submit" value="Submit Discussion" class="btn btn-primary">
        </form>
    </div>

    <!-- Audio recording and transcription -->
    <div class="container my-3" id="audioSection" style="display: none;">
        {% if ai.pk < recentWeek %}
            <button id="recordBtn2" class="btn btn-primary" disabled>Record</button>
        {% else %}
            <button id="recordBtn" class="btn btn-primary">Record</button>
            <!-- Button to stop recording (initially hidden) -->
        {% endif %}
            <button id="stopBtn" type="submit" class="btn btn-danger" style="display: none;">Stop</button>
        <!-- Div to display transcription result -->
        <div id="transcriptionResult" class="mt-3"></div>
    </div>


    <!-- Input prompt -->
    <div class="input-prompt" style="display: none;">
        <!-- Responses -->
        <h4 class="border-bottom my-3 py-2">{{ai.input_set.count}} Responses</h4>
        {% for input in ai.input_set.all reversed %}
        <a id="input_{{ input.id }}"></a>
        <div class="card my-3 {% if input.isTheSame %}border-3 border-success{% else %}border-2 border-danger{% endif %}">
            <div class="card-body">
                {% if input.isTheSame %}
                <div class="card-text">
                    {% if input.errCheckedStr %}
                    <pre class="pre-wrap">{{ input.errCheckedStr|mark }}</pre>
                    {% elif input.content %}
                    <pre class="pre-wrap">{{ input.content|mark }}</pre>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-end">
                    {% if input.modify_date %}
                    <div class="badge bg-light text-dark p-2 text-start mx-3">
                        <div class="mb-2">modified at</div>
                        <div>{{ input.modify_date }}</div>
                    </div>
                    {% endif %}
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ input.author.username }}</div>
                        <div>{{ input.create_date }}</div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0)" data-uri="{% url 'ias:input_vote' input.id  %}"
                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                        <span class="badge rounded-pill bg-success">{{input.voter.count}}</span>
                    </a>
                </div>
                {% else %}
                <!-- Handle the case when input.isTheSame is false -->
                <div class="card-text">
                    {% if input.errCheckedStr %}
                    <pre class="pre-wrap">{{ input.errCheckedStr|mark }}</pre>
                    {% elif input.content %}
                    <pre class="pre-wrap">{{ input.content|mark }}</pre>
                    {% endif %}
                </div>
                <div class="d-flex justify-content-end">
                    {% if input.modify_date %}
                    <div class="badge bg-light text-dark p-2 text-start mx-3">
                        <div class="mb-2">modified at</div>
                        <div>{{ input.modify_date }}</div>
                    </div>
                    {% endif %}
                    <div class="badge bg-light text-dark p-2 text-start">
                        <div class="mb-2">{{ input.author.username }}</div>
                        <div>{{ input.create_date }}</div>
                    </div>
                </div>
                <div class="my-3">
                    <a href="javascript:void(0)" data-uri="{% url 'ias:input_vote' input.id  %}"
                       class="recommend btn btn-sm btn-outline-secondary"> Recommend
                        <span class="badge rounded-pill bg-success">{{input.voter.count}}</span>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</div>

{% endblock content %}

{% block script %}

<script type='text/javascript'>
    // Translation Function.
    // Get references to the toggle button and subject/content display elements
    const toggleButton = document.getElementById('toggleTranslationBtn');
    const subjectDisplay = document.getElementById('subjectDisplay');
    const contentDisplay = document.querySelector('.card-text');
    const toggleLabel = document.querySelector('.toggle-label');
    const responseSection = document.getElementById('responseSection');
    const discussionSection = document.getElementById('discussionSection'); // Added reference for discussion section

    // Initial values for subject and content
    const engSubject = "{{ ai.engSubject }}";
    const korSubject = "{{ ai.korSubject }}";
    const engContent = "{{ ai.engContent|mark }}";
    const korContent = "{{ ai.korContent|mark }}";

    // Set the initial subject and content display
    subjectDisplay.textContent = engSubject;
    contentDisplay.innerHTML = engContent;

    // Set the initial label text
    toggleLabel.textContent = "Korean";

    // Function to show or hide responses based on toggle state
    function toggleResponses() {
        console.log("Toggle button checked:", toggleButton.checked);
        if (toggleButton.checked) {
            responseSection.style.display = "block";
            console.log("Responses shown");
        } else {
            responseSection.style.display = "none";
            console.log("Responses hidden");
        }
    }

    // Function to show or hide discussion section based on toggle state
    // Add event listener to the toggle button
    toggleButton.addEventListener('change', function() {
        // Update the subject and content display based on the toggle state
        if (toggleButton.checked) {
            subjectDisplay.textContent = korSubject;
            contentDisplay.innerHTML = korContent;
            toggleLabel.textContent = "English";
            // Enable copying when in Korean mode
            document.removeEventListener('copy', preventCopy);
        } else {
            subjectDisplay.textContent = engSubject;
            contentDisplay.innerHTML = engContent;
            toggleLabel.textContent = "Korean";
            // Disable copying when in English mode
            document.addEventListener('copy', preventCopy);
        }
        // Show or hide responses based on toggle state
        toggleResponses();
    });

    // Function to show the discussion section and hide the input section
    function showDiscussion() {
        document.querySelector('.discussion-prompt').style.display = 'block';
        document.querySelector('.input-prompt').style.display = 'none';
        document.getElementById('audioSection').style.display = 'none';
    }

    // Function to show the input section and hide the discussion section
    function showInput() {
        document.querySelector('.discussion-prompt').style.display = 'none';
        document.querySelector('.input-prompt').style.display = 'block';
        document.getElementById('audioSection').style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Handle the translation toggle
        const toggleTranslationBtn = document.getElementById('toggleTranslationBtn');
        toggleTranslationBtn.addEventListener('change', function() {
            if (this.checked) {
                showTranslation();
            } else {
                hideTranslation();
            }
        });

        // Show discussion section by default
        showDiscussion();
    });

    function showTranslation() {
        document.querySelectorAll('.korean').forEach(function(el) {
            el.style.display = 'inline';
        });
    }

    function hideTranslation() {
        document.querySelectorAll('.korean').forEach(function(el) {
            el.style.display = 'none';
        });
    }

    function handleWordClick(word) {
        fetchTranslation(word);
    }

    function fetchTranslation(word) {
        const apiUrl = `{% url 'voice:transcribe_audio' ai.pk %}?word=${encodeURIComponent(word)}`;
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                alert(data.translation);
            })
            .catch(error => {
                console.error('Error fetching translation:', error);
            });
    }

    // Audio upload and transcription
    function uploadAndTranscribeAudio() {
        const audioFile = document.getElementById('audioUpload').files[0];
        const formData = new FormData();
        formData.append('audio', audioFile);

        fetch('{% url "voice:transcribe_audio" ai.pk %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            const transcriptionResult = document.getElementById('transcriptionResult');
            if (data.success) {
                transcriptionResult.innerHTML = `<pre>${data.transcription}</pre>`;
            } else {
                transcriptionResult.innerHTML = `<p>Error: ${data.error}</p>`;
            }
        })
        .catch(error => {
            console.error('Error uploading or transcribing audio:', error);
        });
    }

    // Attach event listeners to delete buttons
    document.querySelectorAll('.delete').forEach(button => {
        button.addEventListener('click', function() {
            const uri = this.getAttribute('data-uri');
            fetch(uri, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete');
                }
            });
        });
    });

    // Attach event listeners to recommend buttons
    document.querySelectorAll('.recommend').forEach(button => {
        button.addEventListener('click', function() {
            const uri = this.getAttribute('data-uri');
            fetch(uri, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to recommend');
                }
            });
        });
    });
</script>

<script>
    document.getElementById('recordBtn').addEventListener('click', function() {
        // Show the stop button and hide the record button
        document.getElementById('recordBtn').style.display = 'none';
        document.getElementById('stopBtn').style.display = '';

        // Send a POST request to start recording
        fetch("{% url 'voice:transcribe_audio' ai.pk %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to start recording');
            }
        })
        .catch(error => {
            console.error('Error starting recording:', error);
            alert('An error occurred while starting recording.');
        });
    });

    document.getElementById('stopBtn').addEventListener('click', function() {
        // Send a POST request to stop recording
        fetch("{% url 'voice:interrupt' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to stop recording');
            }
        })
        .catch(error => {
            console.error('Error stopping recording:', error);
            alert('An error occurred while stopping recording.');
        })
        .finally(() => {
            // Hide the stop button and show the record button
            document.getElementById('stopBtn').style.display = 'none';
            document.getElementById('recordBtn').style.display = '';
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Handle the translation toggle
        const toggleTranslationBtn = document.getElementById('toggleTranslationBtn');
        toggleTranslationBtn.addEventListener('change', function() {
            if (this.checked) {
                showTranslation();
            } else {
                hideTranslation();
            }
        });

        // Show discussion section by default
        showDiscussion();
    });

    function showTranslation() {
        document.querySelectorAll('.korean').forEach(function(el) {
            el.style.display = 'inline';
        });
    }

    function hideTranslation() {
        document.querySelectorAll('.korean').forEach(function(el) {
            el.style.display = 'none';
        });
    }

    function showDiscussion() {
        document.querySelector('.discussion-prompt').style.display = 'block';
        document.querySelector('.input-prompt').style.display = 'none';
        document.getElementById('audioSection').style.display = 'none';
    }

    function showInput() {
        document.querySelector('.discussion-prompt').style.display = 'none';
        document.querySelector('.input-prompt').style.display = 'block';
        document.getElementById('audioSection').style.display = 'block';
    }

    function handleWordClick(word) {
        fetchTranslation(word);
    }

    function fetchTranslation(word) {
        const apiUrl = `{% url 'voice:transcribe_audio' ai.pk %}?word=${encodeURIComponent(word)}`;
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                alert(data.translation);
            })
            .catch(error => {
                console.error('Error fetching translation:', error);
            });
    }

    // Audio upload and transcription
    // Attach event listeners to delete buttons
    document.querySelectorAll('.delete').forEach(button => {
        button.addEventListener('click', function() {
            const uri = this.getAttribute('data-uri');
            fetch(uri, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to delete');
                }
            });
        });
    });

    // Attach event listeners to recommend buttons
    document.querySelectorAll('.recommend').forEach(button => {
        button.addEventListener('click', function() {
            const uri = this.getAttribute('data-uri');
            fetch(uri, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(response => {
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Failed to recommend');
                }
            });
        });
    });
</script>
{% endblock script %}
